<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>ä¸­å…±ãƒ—ãƒ­ãƒ‘ã‚¬ãƒ³ãƒ€ãƒ»ãƒ†ã‚­ã‚¹ãƒˆã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --panel-bg: #111;
      --border: #27272a;
      --text: #e5e7eb;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; }
    body {
      background: #000;
      color: var(--text);
      font-family: system-ui, -apple-system, "Segoe UI", "Noto Sans JP",
                   "Hiragino Sans", "Yu Gothic", sans-serif;
    }
    .app {
      display: grid;
      grid-template-columns: 340px 1fr;
      height: 100vh;
      gap: 8px;
    }
    aside {
      background: var(--panel-bg);
      padding: 12px;
      border-right: 1px solid #000;
      overflow: auto;
    }
    main {
      display: flex;
      flex-direction: column;
      background: #000;
    }
    header {
      padding: 10px 16px;
      border-bottom: 1px solid #111;
      font-size: 13px;
      letter-spacing: .08em;
    }
    .field {
      margin-bottom: 10px;
      font-size: 12px;
    }
    .field label {
      display: block;
      margin-bottom: 4px;
      color: #cbd5e1;
    }
    .field input[type="text"],
    .field input[type="number"],
    .field textarea,
    .field select {
      width: 100%;
      padding: 7px 9px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: #050505;
      color: var(--text);
      font-size: 13px;
    }
    .field textarea { resize: vertical; min-height: 140px; }
    .inline { display: flex; gap: 6px; }
    .inline > * { flex: 1; }
    .muted { color: #9ca3af; font-size: 11px; }

    .btn {
      appearance: none;
      border-radius: 9px;
      border: 1px solid #1f2937;
      background: #111827;
      color: #f9fafb;
      padding: 7px 10px;
      font-size: 12px;
      cursor: pointer;
      margin-right: 4px;
    }
    .btn.primary {
      background: linear-gradient(180deg,#b91c1c,#7f1d1d);
      border-color: #7f1d1d;
    }

    .canvas-wrap {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #000;
      overflow: hidden;
    }
    canvas {
      max-width: 100%;
      max-height: 100vh;
      height: auto;
      width: auto;
      background: #000;
      display: block;
    }

    footer {
      padding: 8px 12px;
      border-top: 1px solid #111;
      font-size: 11px;
      color: #9ca3af;
    }

    @media (max-width: 900px) {
      .app { grid-template-columns: 1fr; }
      aside { order: 2; }
      main { order: 1; }
    }
  </style>
</head>
<body>
<div class="app">
  <aside>
    <h2 style="font-size:14px;margin:4px 0 10px;">è¨­å®š</h2>

    <!-- èƒŒæ™¯ç”»åƒé¸æŠ -->
    <div class="field">
      <label>èƒŒæ™¯ç”»åƒé¸æŠ</label>
      <select id="bgSelect">
        <option value="background.png">å¤–äº¤éƒ¨ver</option>
        <option value="background2.png">å›½é˜²éƒ¨ver</option>
        <option value="background3.png">æ¯›å®ver</option>
      </select>
      <div class="muted">èƒŒæ™¯ã‚’åˆ‡ã‚Šæ›¿ãˆ</div>
    </div>

    <!-- å›½æ——é¸æŠï¼ˆæ¯›å®verã®ã¨ãã®ã¿è¡¨ç¤ºï¼‰ -->
    <div class="field" id="flagSelectContainer" style="display: none;">
      <label>ãƒ˜ãƒƒãƒ€ãƒ¼å›½æ——é¸æŠ</label>
      <div class="inline">
        <div class="field">
          <label>å›½æ——1</label>
          <select id="flag1">
            <option value="">èª­ã¿è¾¼ã¿ä¸­...</option>
          </select>
        </div>
        <div class="field">
          <label>å›½æ——2</label>
          <select id="flag2">
            <option value="">èª­ã¿è¾¼ã¿ä¸­...</option>
          </select>
        </div>
      </div>
      <div class="muted">æ¯›å®verã®ã¨ãã®ã¿è¡¨ç¤º</div>
    </div>
    
    <div class="field">
      <label>ãƒ¡ã‚¤ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ</label>
      <textarea id="text" placeholder="â€œæ—¥æœ¬ã¯å†ã³è»å›½ä¸»ç¾©ã®éã¡ã‚’ç¹°ã‚Šè¿”ã™ã¤ã‚‚ã‚Šãªã®ã‹â€¦â€"></textarea>
    </div>

    <!-- é¸æŠéƒ¨åˆ†ã‚’é‡‘è‰²ã«ã™ã‚‹ãƒœã‚¿ãƒ³ -->
    <div class="field">
      <button class="btn" id="highlightGoldBtn" type="button">
        é¸æŠéƒ¨åˆ†ã‚’é‡‘è‰²ã«ã™ã‚‹
      </button>
      <div class="muted">
        ãƒ†ã‚­ã‚¹ãƒˆå†…ã§ç¯„å›²é¸æŠã—ã¦ã‹ã‚‰æŠ¼ã™ã¨ã€ãã®éƒ¨åˆ†ã ã‘é‡‘è‰²ã§æç”»ã•ã‚Œã¾ã™ã€‚
      </div>
    </div>

    <div class="inline">
      <div class="field">
        <label>æœ¬æ–‡ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚º(px)</label>
        <input id="fontSize" type="number" value="80" min="24" max="160" step="2">
      </div>
      <div class="field">
        <label>è¡Œé–“(å€ç‡)</label>
        <input id="lineHeight" type="number" value="1.25" step="0.05" min="1" max="2">
      </div>
    </div>

    <div class="inline">
      <div class="field">
        <label>å·¦å³ãƒãƒ¼ã‚¸ãƒ³(%)</label>
        <input id="marginX" type="number" value="12" min="5" max="25">
      </div>
      <div class="field">
        <label>ä¸Šã‹ã‚‰ã®é–‹å§‹ä½ç½®(%)</label>
        <input id="startY" type="number" value="22" min="10" max="40">
      </div>
    </div>

    <div class="inline">
      <div class="field">
        <label>ãƒ†ã‚­ã‚¹ãƒˆè‰²</label>
        <input id="textColor" type="color" value="#fdf5e6">
      </div>
      <div class="field">
        <label>å½±(ã¼ã‹ã— px)</label>
        <input id="shadowBlur" type="number" value="6" min="0" max="30">
      </div>
    </div>

    <div class="field">
      <label>ãƒ•ã‚©ãƒ³ãƒˆ</label>
      <select id="fontFamily">
        <option value="serif">æ˜æœä½“é¢¨ (Noto Serif JP)</option>
        <option value="sans">ã‚´ã‚·ãƒƒã‚¯ä½“é¢¨ (Noto Sans JP)</option>
      </select>
    </div>

    <div class="field">
      <label>å¼•ç”¨ç¬¦</label>
      <select id="quoteMode">
        <option value="both">â€œ â€¦ â€ ã‚’ä»˜ã‘ã‚‹</option>
        <option value="none">ä»˜ã‘ãªã„</option>
      </select>
    </div>

    <div class="field">
      <label>ãƒ•ãƒƒã‚¿ãƒ¼ãƒ†ã‚­ã‚¹ãƒˆï¼ˆä»»æ„ãƒ»ä¸€ç•ªä¸‹ï¼‰</label>
      <input id="footerText" type="text" placeholder="ä¸­å›½å¤–äº¤éƒ¨å ±é“å®˜ 2025å¹´11æœˆ13æ—¥">
      <div class="muted">ç©ºãªã‚‰ãƒ•ãƒƒã‚¿ãƒ¼éè¡¨ç¤º</div>
    </div>

    <div class="field">
      <label>ãƒ•ãƒƒã‚¿ãƒ¼ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚º(px)</label>
      <input id="footerSize" type="number" value="32" min="18" max="80">
    </div>

    <div style="margin-top:10px;">
      <button class="btn" id="renderBtn">å†æç”»</button>
      <button class="btn primary" id="saveBtn">JPGã¨ã—ã¦ä¿å­˜</button>
      <div class="muted">å³ã‚¯ãƒªãƒƒã‚¯ã§ä¿å­˜ã—ãŸã»ã†ãŒæ—©ã„ã‹ã‚‚</div>
    </div>
  </aside>

  <main>
    <header>ä¸­å…±ãƒ—ãƒ­ãƒ‘ã‚¬ãƒ³ãƒ€ãƒ»ãƒ†ã‚­ã‚¹ãƒˆã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼</header>
    <div class="canvas-wrap">
      <canvas id="cv"></canvas>
    </div>
  </main>
</div>

<script>
  const HIGHLIGHT_COLOR = "#D8AE5C";

  const els = {
    cv: document.getElementById('cv'),
    bgSelect: document.getElementById('bgSelect'),
    text: document.getElementById('text'),
    fontSize: document.getElementById('fontSize'),
    lineHeight: document.getElementById('lineHeight'),
    marginX: document.getElementById('marginX'),
    startY: document.getElementById('startY'),
    textColor: document.getElementById('textColor'),
    shadowBlur: document.getElementById('shadowBlur'),
    fontFamily: document.getElementById('fontFamily'),
    quoteMode: document.getElementById('quoteMode'),
    footerText: document.getElementById('footerText'),
    footerSize: document.getElementById('footerSize'),
    renderBtn: document.getElementById('renderBtn'),
    saveBtn: document.getElementById('saveBtn'),
    highlightGoldBtn: document.getElementById('highlightGoldBtn'),
    flagSelectContainer: document.getElementById('flagSelectContainer'),
    flag1: document.getElementById('flag1'),
    flag2: document.getElementById('flag2')
  };

  // å¹´æœˆæ—¥ã‚’ã€Œ2025å¹´11æœˆ13æ—¥ã€å½¢å¼ã§è¿”ã™
  function formatDateJP(d) {
    const y = d.getFullYear();
    const m = d.getMonth() + 1;
    const day = d.getDate();
    return `${y}å¹´${m}æœˆ${day}æ—¥`;
  }

  // èƒŒæ™¯èª­ã¿è¾¼ã¿é–¢æ•°
  let bgImg;
  function loadBackground(name) {
    bgImg = new Image();
    bgImg.onload = () => {
      els.cv.width = bgImg.width;
      els.cv.height = bgImg.height;
      render();
    };
    bgImg.src = './' + name;
  }

  // åˆæœŸãƒ†ã‚­ã‚¹ãƒˆ
  els.text.value =
    "æ—¥æœ¬ã¯å†ã³è»å›½ä¸»ç¾©ã®éã¡ã‚’ç¹°ã‚Šè¿”ã™ã¤ã‚‚ã‚Šãªã®ã‹\n\n" +
    "å†ã³ä¸­å›½äººæ°‘ã¨ã‚¢ã‚¸ã‚¢äººæ°‘ã‚’æ•µã«å›ã™ã¤ã‚‚ã‚Šãªã®ã‹\n\n" +
    "æˆ¦å¾Œã®å›½éš›ç§©åºã‚’è¦†ãã†ã¨ã—ã¦ã„ã‚‹ã®ã‹";

  // footer åˆæœŸå€¤ï¼ˆå¤–äº¤éƒ¨ + ä»Šæ—¥ï¼‰
  els.footerText.value = "ä¸­å›½å¤–äº¤éƒ¨å ±é“å®˜ " + formatDateJP(new Date());

  // åˆæœŸèƒŒæ™¯ï¼ˆå¤–äº¤éƒ¨ï¼‰
  loadBackground('background.png');
  
  // åˆæœŸçŠ¶æ…‹ã§å›½æ——é¸æŠã‚’éè¡¨ç¤º
  els.flagSelectContainer.style.display = 'none';

  // å›½æ——ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã«è¡¨ç¤º
  let flagsData = [];
  function loadFlags() {
    fetch('./flags.json')
      .then(response => response.json())
      .then(data => {
        flagsData = data;
        populateFlagSelects();
      })
      .catch(error => {
        console.error('å›½æ——ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: åŸºæœ¬çš„ãªå›½æ——ã®ã¿
        flagsData = [
          {code: "CN", emoji: "ğŸ‡¨ğŸ‡³", name: "ä¸­å›½"},
          {code: "JP", emoji: "ğŸ‡¯ğŸ‡µ", name: "æ—¥æœ¬"},
          {code: "US", emoji: "ğŸ‡ºğŸ‡¸", name: "ã‚¢ãƒ¡ãƒªã‚«"},
          {code: "KR", emoji: "ğŸ‡°ğŸ‡·", name: "éŸ“å›½"},
          {code: "RU", emoji: "ğŸ‡·ğŸ‡º", name: "ãƒ­ã‚·ã‚¢"},
          {code: "GB", emoji: "ğŸ‡¬ğŸ‡§", name: "ã‚¤ã‚®ãƒªã‚¹"},
          {code: "FR", emoji: "ğŸ‡«ğŸ‡·", name: "ãƒ•ãƒ©ãƒ³ã‚¹"},
          {code: "DE", emoji: "ğŸ‡©ğŸ‡ª", name: "ãƒ‰ã‚¤ãƒ„"}
        ];
        populateFlagSelects();
      });
  }

  // å›½æ——é¸æŠãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’ç”Ÿæˆ
  function populateFlagSelects() {
    // å›½æ——1ã¨å›½æ——2ã®ä¸¡æ–¹ã®ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’ã‚¯ãƒªã‚¢
    els.flag1.innerHTML = '';
    els.flag2.innerHTML = '';

    // å…¨ã¦ã®å›½æ——ã‚’è¿½åŠ 
    flagsData.forEach(flag => {
      const option1 = document.createElement('option');
      option1.value = flag.emoji;
      option1.textContent = `${flag.name} ${flag.emoji}`;
      if (flag.code === 'CN') option1.selected = true; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: ä¸­å›½
      els.flag1.appendChild(option1);

      const option2 = document.createElement('option');
      option2.value = flag.emoji;
      option2.textContent = `${flag.name} ${flag.emoji}`;
      if (flag.code === 'JP') option2.selected = true; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: æ—¥æœ¬
      els.flag2.appendChild(option2);
    });
  }

  // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«å›½æ——ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
  loadFlags();

  function getFontFamily() {
    if (els.fontFamily.value === 'serif') {
      return '"Noto Serif JP","Hiragino Mincho ProN","Yu Mincho",serif';
    }
    return '"Noto Sans JP","Hiragino Sans","Yu Gothic",sans-serif';
  }

  // [g]...[/g] ã‚’è§£æã—ã¦è‰²ä»˜ããƒˆãƒ¼ã‚¯ãƒ³åˆ—ã«å¤‰æ›
  function parseTokens(text, baseColor, highlightColor) {
    const tokens = [];
    let i = 0;
    let currentColor = baseColor;
    while (i < text.length) {
      if (text.startsWith("[g]", i)) {
        currentColor = highlightColor;
        i += 3;
        continue;
      }
      if (text.startsWith("[/g]", i)) {
        currentColor = baseColor;
        i += 4;
        continue;
      }
      const ch = text[i];
      tokens.push({ char: ch, color: currentColor });
      i++;
    }
    return tokens;
  }

  // ãƒˆãƒ¼ã‚¯ãƒ³åˆ—ã‚’è¡Œã”ã¨ã«åˆ†å‰²ï¼ˆè‡ªå‹•æŠ˜ã‚Šè¿”ã—ï¼‰
  function layoutTokens(ctx, tokens, maxWidth) {
    const lines = [];
    let currentTokens = [];
    let currentWidth = 0;

    for (const t of tokens) {
      if (t.char === "\n") {
        // æ”¹è¡Œã§è¡Œã‚’ç¢ºå®š
        lines.push({ tokens: currentTokens, width: currentWidth });
        currentTokens = [];
        currentWidth = 0;
        continue;
      }

      const w = ctx.measureText(t.char).width;
      if (currentWidth + w > maxWidth && currentTokens.length > 0) {
        // æŠ˜ã‚Šè¿”ã—
        lines.push({ tokens: currentTokens, width: currentWidth });
        currentTokens = [t];
        currentWidth = w;
      } else {
        currentTokens.push(t);
        currentWidth += w;
      }
    }

    if (currentTokens.length > 0) {
      lines.push({ tokens: currentTokens, width: currentWidth });
    }

    return lines;
  }

  function render() {
    const cv = els.cv;
    const ctx = cv.getContext('2d');
    ctx.clearRect(0, 0, cv.width, cv.height);

    // èƒŒæ™¯
    if (bgImg && bgImg.complete) {
      ctx.drawImage(bgImg, 0, 0, cv.width, cv.height);
    } else {
      ctx.fillStyle = "#7a1010";
      ctx.fillRect(0, 0, cv.width, cv.height);
    }

    const W = cv.width;
    const H = cv.height;

    // æ¯›å®verã®ã¨ãã€å›½æ——ã‚’ãƒ˜ãƒƒãƒ€ãƒ¼éƒ¨åˆ†ã«æç”»
    if (els.bgSelect.value === 'background3.png') {
      const flag1 = els.flag1.value;
      const flag2 = els.flag2.value;
      const flagSize = Math.min(W * 0.11, H * 0.11); // ç”»é¢ã‚µã‚¤ã‚ºã«å¿œã˜ãŸå›½æ——ã‚µã‚¤ã‚º
      const flagY = H * 0.1; // ä¸Šã‹ã‚‰6%ã®ä½ç½®
      const flagSpacing = W * 0.05; // å›½æ——é–“ã®ã‚¹ãƒšãƒ¼ã‚¹
      const totalWidth = flagSize * 2 + flagSpacing;
      const flagX = (W - totalWidth) / 2; // ä¸­å¤®æƒãˆ

      ctx.save();
      ctx.font = `${flagSize}px Arial, sans-serif`;
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      
      // å›½æ——1ã‚’æç”»
      ctx.fillText(flag1, flagX + flagSize / 2, flagY);
      
      // å›½æ——2ã‚’æç”»
      ctx.fillText(flag2, flagX + flagSize + flagSpacing + flagSize / 2, flagY);
      
      ctx.restore();
    }

    // ãƒ†ã‚­ã‚¹ãƒˆè¨­å®š
    const fontSize = parseInt(els.fontSize.value, 10) || 80;
    const lineHeight = parseFloat(els.lineHeight.value) || 1.25;
    const marginX = (parseFloat(els.marginX.value) || 10) / 100;
    const startYRatio = (parseFloat(els.startY.value) || 20) / 100;
    const baseColor = els.textColor.value || "#ffffff";
    const shadowBlur = parseInt(els.shadowBlur.value, 10) || 0;

    const areaX = W * marginX;
    const areaW = W - areaX * 2;
    const startY = H * startYRatio;

    // æœ¬æ–‡ï¼ˆå¼•ç”¨ç¬¦ï¼‹ãƒˆãƒ¼ã‚¯ãƒ³åŒ–ï¼‰
    let raw = els.text.value;
    if (els.quoteMode.value === "both" && raw.trim()) {
      raw = "â€œ" + raw + "â€";
    }

    ctx.save();
    ctx.textBaseline = "top";
    ctx.shadowColor = "rgba(0,0,0,0.85)";
    ctx.shadowBlur = shadowBlur;
    ctx.font = `700 ${fontSize}px ${getFontFamily()}`;

    const tokens = parseTokens(raw, baseColor, HIGHLIGHT_COLOR);
    const lines = layoutTokens(ctx, tokens, areaW);
    const linePx = fontSize * lineHeight;

    let y = startY;
    for (const line of lines) {
      const xStart = (W - line.width) / 2;
      let x = xStart;
      for (const t of line.tokens) {
        ctx.fillStyle = t.color;
        ctx.fillText(t.char, x, y);
        x += ctx.measureText(t.char).width;
      }
      y += linePx;
    }
    ctx.restore();

    // ãƒ•ãƒƒã‚¿ãƒ¼
    const footerText = els.footerText.value.trim();
    if (footerText) {
      const fSize = parseInt(els.footerSize.value, 10) || 32;
      const bottomMargin = H * 0.06;

      ctx.save();
      ctx.font = `500 ${fSize}px "Noto Serif JP","Hiragino Mincho ProN","Yu Mincho",serif`;
      ctx.textBaseline = "alphabetic";
      ctx.textAlign = "center";
      ctx.fillStyle = baseColor;
      ctx.shadowColor = "rgba(0,0,0,0.9)";
      ctx.shadowBlur = shadowBlur;

      const yFooter = H - bottomMargin;
      // ä¸Šã«ç´°ã„ãƒ©ã‚¤ãƒ³
      ctx.shadowBlur = 0;
      ctx.globalAlpha = 0.85;
      ctx.fillRect(W * 0.15, yFooter - fSize * 1.6, W * 0.70, 2);

      ctx.globalAlpha = 1;
      ctx.shadowBlur = shadowBlur;
      ctx.fillText(footerText, W / 2, yFooter);
      ctx.restore();
    }
  }

  // èƒŒæ™¯åˆ‡ã‚Šæ›¿ãˆã‚¤ãƒ™ãƒ³ãƒˆ
  els.bgSelect.addEventListener('change', () => {
    const selected = els.bgSelect.value;
    loadBackground(selected);
    const today = formatDateJP(new Date());
    
    // æ¯›å®verã®ã¨ãã¯å›½æ——é¸æŠã‚’è¡¨ç¤ºã€ãã‚Œä»¥å¤–ã¯éè¡¨ç¤º
    if (selected === 'background3.png') {
      els.flagSelectContainer.style.display = 'block';
      els.footerText.value = `ä¸­å›½å¤–äº¤éƒ¨å ±é“å®˜ ${today}`;
    } else {
      els.flagSelectContainer.style.display = 'none';
      if (selected === 'background2.png') {
        els.footerText.value = `ä¸­å›½å›½é˜²éƒ¨å ±é“å®˜ ${today}`;
      } else {
        els.footerText.value = `ä¸­å›½å¤–äº¤éƒ¨å ±é“å®˜ ${today}`;
      }
    }
    render();
  });

  // ãƒ†ã‚­ã‚¹ãƒˆé¸æŠéƒ¨åˆ†ã‚’ [g]â€¦[/g] ã§å›²ã‚“ã§é‡‘è‰²ã«ã™ã‚‹
  els.highlightGoldBtn.addEventListener('click', () => {
    const ta = els.text;
    const start = ta.selectionStart;
    const end = ta.selectionEnd;
    if (start === end) return; // é¸æŠãªã—

    const value = ta.value;
    const before = value.slice(0, start);
    const selected = value.slice(start, end);
    const after = value.slice(end);

    ta.value = before + "[g]" + selected + "[/g]" + after;

    // ä¸€å¿œã‚«ãƒ¼ã‚½ãƒ«ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆæœ«å°¾ã«ç§»å‹•
    const newPos = before.length + "[g]".length + selected.length + "[/g]".length;
    ta.focus();
    ta.selectionStart = ta.selectionEnd = newPos;

    render();
  });

  // å…¥åŠ›ã®ãŸã³ã«å†æç”»
  [
    "text","fontSize","lineHeight","marginX","startY",
    "textColor","shadowBlur","fontFamily","quoteMode",
    "footerText","footerSize","flag1","flag2"
  ].forEach(id => {
    els[id].addEventListener("input", render);
    els[id].addEventListener("change", render);
  });

  els.renderBtn.addEventListener("click", render);

  els.saveBtn.addEventListener("click", () => {
  const src = els.cv; // å…ƒã‚­ãƒ£ãƒ³ãƒã‚¹

  // â˜… ä¿å­˜ç”¨ã®ä½è§£åƒåº¦ã‚­ãƒ£ãƒ³ãƒã‚¹ä½œæˆ
  const scale = 0.5;  // â† è§£åƒåº¦ 50%ï¼ˆãŠå¥½ã¿ã§ 0.3ã€œ0.7 ã«å¤‰æ›´å¯ï¼‰
  const w = src.width * scale;
  const h = src.height * scale;

  const off = document.createElement("canvas");
  off.width = w;
  off.height = h;

  const offCtx = off.getContext("2d");
  offCtx.drawImage(src, 0, 0, w, h);

  // â˜… JPEG ã§ä¿å­˜ï¼ˆè¶…é«˜é€Ÿï¼‰
  off.toBlob((blob) => {
    if (!blob) return;

    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "propaganda.jpg";
    a.click();
    URL.revokeObjectURL(url);
  }, "image/jpeg", 0.92);
  });

  // åˆæœŸæç”»ï¼ˆèƒŒæ™¯èª­ã¿è¾¼ã¿å‰ã¯èµ¤ãƒ™ã‚¿ï¼‹ãƒ†ã‚­ã‚¹ãƒˆã€èª­ã¿è¾¼ã¿å¾Œã«è‡ªå‹•ã§å†æç”»ï¼‰
  window.onload = render;
</script>
</body>
</html>
